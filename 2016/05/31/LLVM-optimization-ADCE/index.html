<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>LLVM optimization--ADCE | LLVM&amp;Clang</title><link rel="stylesheet" type="text/css" href="/css/normalize.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/pure-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">LLVM optimization--ADCE</h1><a id="logo" href="/.">LLVM&amp;Clang</a><p class="description">关于llvm和clang的分享</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">LLVM optimization--ADCE</h1><div class="post-meta"><i class="fa fa-calendar"> 2016-05-31</i></div><span data-thread-key="2016/05/31/LLVM-optimization-ADCE/" class="ds-thread-count"></span><div class="post-content"><h2 id="编译优化"><a href="#编译优化" class="headerlink" title="编译优化"></a>编译优化</h2><p>对于编译器来说， 优化是必须要经历的一个阶段， 经过优化的代码可以拥有更小的体积和更高效的执行， 具体的内容可以参考龙书编译原理。对于clang这个编译器前端而言， 代码的优化程度有一下的几个等级：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Specify which optimization level to <span class="operator"><span class="keyword">use</span>:</span><br><span class="line">	</span><br><span class="line">	-O0 Means “<span class="keyword">no</span> optimization”: this <span class="keyword">level</span> compiles the fastest <span class="keyword">and</span> generates the most debuggable code.</span><br><span class="line">	-O1 Somewhere <span class="keyword">between</span> -O0 <span class="keyword">and</span> -O2.</span><br><span class="line">	-O2 Moderate <span class="keyword">level</span> <span class="keyword">of</span> optimization which enables most optimizations.</span><br><span class="line">	-O3 <span class="keyword">Like</span> -O2, <span class="keyword">except</span> that it enables optimizations that take longer <span class="keyword">to</span> perform <span class="keyword">or</span> that may generate larger code (<span class="keyword">in</span> an attempt <span class="keyword">to</span> make the program run faster).</span><br><span class="line">	-O <span class="keyword">fast</span> Enables all the optimizations <span class="keyword">from</span> -O3 along <span class="keyword">with</span> other aggressive optimizations that may violate <span class="keyword">strict</span> compliance <span class="keyword">with</span> <span class="keyword">language</span> standards.</span><br><span class="line">	-Os <span class="keyword">Like</span> -O2 <span class="keyword">with</span> extra optimizations <span class="keyword">to</span> reduce code <span class="keyword">size</span>.</span><br><span class="line">	-Oz <span class="keyword">Like</span> -Os (<span class="keyword">and</span> thus -O2), but reduces code <span class="keyword">size</span> further.</span><br><span class="line">	-O Equivalent <span class="keyword">to</span> -O2.</span><br><span class="line">	-O4 <span class="keyword">and</span> higher</span><br><span class="line">	Currently equivalent <span class="keyword">to</span> -O3</span></span><br></pre></td></tr></table></figure>
<p>对于一个Hello world的C语言而言， 编译器对它的优化所占用的时间如下：<br><img src="/img/ADCE/ADCE_opt_1.png" alt="Syntax highlighting example"></p>
<p>从整个编译的时间来看， 其所花的时间并不算太多（大概1%）。但却是很重要的一环。</p>
<h2 id="编译器优化实现"><a href="#编译器优化实现" class="headerlink" title="编译器优化实现"></a>编译器优化实现</h2><p>在llvm中， 有一类被称为Pass的编程组件， 被用作实现优化。Pass的优化单位有以下几种：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> Module</span><br><span class="line"><span class="number">2.</span> Basic Block</span><br><span class="line"><span class="number">3.</span> Function</span><br><span class="line"><span class="number">4.</span> instruction</span><br></pre></td></tr></table></figure>
<p>针对不同的优化单元， 只要继承不同单元的Pass就好了。比如， 目前想对Module进行优化，<br>那么在代码中只要写如下的类就可以完成：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPass</span> : <span class="typename">public ModulePass</span></span></span><br></pre></td></tr></table></figure>
<p>其他的以此类推。<br><br>编译器自带一系列的优化组件， 根据我们在编译代码时候制定的不同的优化等级， 动态的增加对应的优化组件。<br><br>下面将介绍一个简单的编译器优化单元， ADCE(Aggressive Dead Code Elimination).</p>
<p>##ADCE (Aggressive Dead Code Elimination)</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>优化准则中给出了如下的定义:<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Dead</span> <span class="type">Code</span> <span class="keyword">is</span> code whose <span class="literal">result</span> are never used <span class="keyword">in</span> <span class="type">any</span> useful</span><br><span class="line">statement. <span class="string">"Useful statements"</span>, at first approximation, </span><br><span class="line">are simply output statements since those are the only ones </span><br><span class="line">that perform <span class="type">any</span> action directly seen by the outside world</span><br></pre></td></tr></table></figure></p>
<p>简单的来说， ADCE主要做的事情是删减那些没有运行过的指令。</p>
<h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><figure class="highlight cal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">eliminateDeadCode</span><span class="params">(P)</span>	</span><br><span class="line">		<span class="comment">//P is the procedure in which constants are to be propagated</span></span><br><span class="line">		<span class="comment">//Assume the availability of def-use chains for all the statements in P</span></span><br><span class="line">		<span class="title">let</span> <span class="title">worklist</span> :</span>= &#123;absolutely useful statements&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span> worklist ≠ Ø <span class="keyword">do</span> <span class="keyword">begin</span></span><br><span class="line">			x:= an arbitrary element <span class="keyword">of</span> worklist</span><br><span class="line">			make x useful</span><br><span class="line">			worklist := worklist - &#123;x&#125;</span><br><span class="line">			<span class="keyword">for</span> all (y, x) ∈ defuse <span class="keyword">do</span></span><br><span class="line">				<span class="keyword">if</span> y is <span class="keyword">not</span> marked useful <span class="keyword">then</span></span><br><span class="line">					worklist := worklist ∪ &#123;y&#125;;</span><br><span class="line">				<span class="keyword">end</span></span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		delete every statement that is <span class="keyword">not</span> marked useful</span><br><span class="line"><span class="keyword">end</span> eliminateDeadCode</span><br></pre></td></tr></table></figure>
<p>简单的描述一下算法：</p>
<ol>
<li>假设存在这样一个集合worklist， 这个集合里面的所有的指令都是一定会被使用的；<br></li>
<li>那么我们遍历这个指令， 并将这个集合中的所有的指令标为有效。<br></li>
<li>假设当前遍历出来的指令为X， 那么检查当前有哪些其他的指令使用了这条指令， 并将使这些指令标记为有效， 最后吧这些指令加入worklist；<br></li>
<li>循环执行1， 如果worklist为空， 那么停止循环。<br></li>
<li>最后遍历所有的指令， 删除没有被标记为有效的指令。<br></li>
</ol>
<p>###LLVM中的实现</p>
<h4 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h4><p>LLVM中实现上述优化算法的组件被称作“ADCE”(Aggressive Dead Code Elimination).当用户在编译代码的时候制定了O0以上的优化选项， 就会调用该优化。</p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><ol>
<li>数据准备方面: <br><br>ADCE中使用了两个变长数组alive和worklist， worklist主要包含待扫描的指令， alive中的指令表示当前这些指令是有效的， 不用被删除的。</li>
<li>worklist初始数据：<br><br> 扫描一遍全部指令， 如果当前的指令是TerminatorInst， DbgInfoIntrinsic， LandingPadInst 或者 当前指令有写内存的操作， 会抛出异常，call指令的返回值没有return（最后三种被统称为可能会导致副作用的指令集）。</li>
<li>最后扫面全部的指令， 如果当前的指令不在alive中， 直接删除。</li>
</ol>
<p>Happy Hacking</p>
<p>Best Regards<br>Axis</p>
</div><a data-url="http://dongaxis.github.io/2016/05/31/LLVM-optimization-ADCE/" data-id="ciouzsoig000084m7jx7we9go" class="article-share-link">分享到</a><div class="tags"><a href="/tags/LLVM-optimization/">LLVM optimization</a></div><div class="post-nav"><a href="/2016/05/26/Swift-Parser/" class="next">Swift Parser <i class="fa fa-caret-right"></i></a></div><div data-thread-key="2016/05/31/LLVM-optimization-ADCE/" data-title="LLVM optimization--ADCE" data-url="http://dongaxis.github.io/2016/05/31/LLVM-optimization-ADCE/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/05/31/LLVM-optimization-ADCE/" data-title="LLVM optimization--ADCE" data-url="http://dongaxis.github.io/2016/05/31/LLVM-optimization-ADCE/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><input placeholder="Search" type="text" class="st-default-search-input"/></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/LLVM-optimization/" style="font-size: 15px;">LLVM optimization</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/xcode7-ios9/" style="font-size: 15px;">xcode7 ios9</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/05/31/LLVM-optimization-ADCE/">LLVM optimization--ADCE</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/26/Swift-Parser/">Swift Parser</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/28/Swift-Swiftc/">Swift & Swiftc</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/23/封装抽象平台指针/">封装抽象平台指针</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/17/xcode7新特性bitcode/">xcode7新特性bitcode</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://dongaxis.github.io/" title="我的另一个小站" target="_blank">我的另一个小站</a><ul></ul><a href="http://www.lovedebug.com/" title="朋友的小站" target="_blank">朋友的小站</a></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">LLVM&amp;Clang.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/jquery.min.js?v=0.0.0"></script><script type="text/javascript" src="/js/totop.js?v=0.0.0"></script><script type="text/javascript" src="/js/fancybox.pack.js?v=0.0.0"></script><script type="text/javascript" src="/js/jquery.fancybox.js?v=0.0.0"></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'axis'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

_st('install','WByUbNsQELKG-pwbCCLo','2.0.0');
</script><script type="text/javascript" src="/js/share.js?v=0.0.0"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>